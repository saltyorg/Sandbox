#########################################################################
# Title:         Sandbox: ruTorrent                                     #
# Author(s):     keldian                                                #
# URL:           https://github.com/saltyorg/Sandbox                    #
# --                                                                    #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: Add DNS record
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/dns/tasker.yml"
  vars:
    dns_record: "{{ lookup('role_var', '_dns_record') }}"
    dns_zone: "{{ lookup('role_var', '_dns_zone') }}"
    dns_proxy: "{{ lookup('role_var', '_dns_proxy') }}"

- name: Add WebDAV DNS record
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/dns/tasker.yml"
  vars:
    dns_record: "{{ lookup('role_var', '_webdav_dns_record') }}"
    dns_zone: "{{ lookup('role_var', '_webdav_dns_zone') }}"
    dns_proxy: "{{ lookup('role_var', '_webdav_dns_proxy') }}"
  when: lookup('role_var', '_webdav_enable', default=true) | bool

- name: Remove existing Docker container
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"

- name: Create directories
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/directories/create_directories.yml"

- name: Check if config file exists
  ansible.builtin.stat:
    path: "{{ rutorrent_role_paths_location }}/rtorrent/.rtorrent.rc"
  register: rutorrent_rtorrent_config

- name: Get public trackers toggle
  ansible.builtin.set_fact:
    rutorrent_public_trackers_enable: "{{ not lookup('role_var', '_public_trackers_disable', default=true) | bool }}"

- name: Import managed config file
  ansible.builtin.template:
    src: "rtorrent.rc.j2"
    dest: "{{ rutorrent_role_paths_location }}/rtorrent/.rtorrent.rc"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0664"
  when: not rutorrent_rtorrent_config.stat.exists

- name: Update managed settings in config file
  community.general.ini_file:
    path: "{{ rutorrent_role_paths_location }}/rtorrent/.rtorrent.rc"
    section: null
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    no_extra_spaces: false
    state: present
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0664"
  loop:
    - { option: "dht.mode.set", value: "{{ rutorrent_public_trackers_enable | ternary('auto', 'disable') }}" }
    - { option: "trackers.use_udp.set", value: "{{ rutorrent_public_trackers_enable | ternary('yes', 'no') }}" }
    - { option: "protocol.pex.set", value: "{{ rutorrent_public_trackers_enable | ternary('yes', 'no') }}" }
  when: (lookup('role_var', '_manage_rt_config_enable', default=true) | bool) and rutorrent_rtorrent_config.stat.exists

- name: Import managed `conf.php` for Diskspace plugin
  ansible.builtin.template:
    src: "diskspace_conf.php.j2"
    dest: "{{ rutorrent_role_paths_location }}/rutorrent/plugins-conf/diskspace/conf.php"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"

- name: Get port range low bounds
  ansible.builtin.set_fact:
    rutorrent_dht_port_low: "{{ rutorrent_dht_port_low | default(lookup('role_var', '_rt_dht_port', default=6881)) }}"
    rutorrent_inc_port_low: "{{ rutorrent_inc_port_low | default(lookup('role_var', '_rt_inc_port', default=50000)) }}"

- name: Get next available port for DHT # noqa fqcn[action]
  find_open_port:
    low_bound: "{{ rutorrent_dht_port_low }}"
    high_bound: "{{ rutorrent_dht_port_low + 10 }}"
    protocol: udp
  register: rutorrent_port_lookup_dht
  ignore_errors: true

- name: Get next available port for incoming connections # noqa fqcn[action]
  find_open_port:
    low_bound: "{{ rutorrent_inc_port_low }}"
    high_bound: "{{ rutorrent_inc_port_low + 10 }}"
    protocol: both
  register: rutorrent_port_lookup_inc
  ignore_errors: true

- name: Update port ranges for next iteration
  ansible.builtin.set_fact:
    rutorrent_dht_port_low: "{{ (lookup('role_var', '_docker_port_dht') | int) + (rutorrent_public_trackers_enable | int) }}"
    rutorrent_inc_port_low: "{{ (lookup('role_var', '_docker_port_inc') | int) + 1 }}"

- name: Create Docker container
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/create_docker_container.yml"
