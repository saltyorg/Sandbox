#########################################################################
# Title:            Sandbox: code-server                                #
# Author(s):        GiorgioBrux                                         #
# URL:              https://github.com/saltyorg/Sandbox                 #
# --                                                                    #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: Legacy | Check if '{{ server_appdata_path }}/coder' folder exists
  ansible.builtin.stat:
    path: "{{ server_appdata_path }}/coder"
  register: code_server_oldfolder

- name: Legacy | Check if {{ lookup('role_var', '_paths_location', role='code_server') }} folder exists
  ansible.builtin.stat:
    path: "{{ lookup('role_var', '_paths_location', role='code_server') }}"
  register: code_server_newfolder

- name: "Legacy | Fail when '{{ server_appdata_path }}/coder' does not exist"
  ansible.builtin.fail:
    msg: "A migration has been attempted, but the {{ server_appdata_path }}/coder folder is missing. If you have already run the migration once, you don't need to pass the -e 'code_server_migrate_coder=true' argument anymore. If this is your first time running the migration but you're using a custom folder, move the folder manually to '{{ server_appdata_path }}/code-server', remove the old 'coder' subdomain then run the tag normally."
  when: (not code_server_oldfolder.stat.exists)

- name: "Legacy | Fail when {{ lookup('role_var', '_paths_location', role='code_server') }} already exists"
  ansible.builtin.fail:
    msg: "A migration has been attempted, but the {{ lookup('role_var', '_paths_location', role='code_server') }} folder already exists. If you have already run the migration once, you don't need to pass the -e 'code_server_migrate_coder=true' argument anymore. If this is your first time running the migration, then you have created a folder manually or have already a container using the {{ lookup('role_var', '_paths_location', role='code_server') }} folder. In order for the migration to actually run, an '{{ server_appdata_path }}/coder' folder must exists, while {{ lookup('role_var', '_paths_location', role='code_server') }} must not."
  when: (code_server_newfolder.stat.exists)

- name: Legacy | Delete old DNS record
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/dns/tasker.yml"
  vars:
    dns_record: "coder"
    dns_action: "remove"

- name: Legacy | Stop and remove coder container
  community.docker.docker_container:
    name: coder
    state: absent

- name: Legacy | Move opt folder 'coder' to 'code-server'
  ansible.builtin.shell: |
    mv {{ server_appdata_path }}/coder "{{ lookup('role_var', '_paths_location', role='code_server') }}"

- name: Legacy | Set permissions on 'code_server'
  ansible.builtin.file:
    path: "{{ lookup('role_var', '_paths_location', role='code_server') }}"
    state: directory
    recurse: true
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
