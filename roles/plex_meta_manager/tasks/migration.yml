#########################################################################
# Title:         Sandbox: Plex Meta Manager to Kometa Migration         #
# Author(s):     owine                                                  #
# URL:           https://github.com/saltyorg/Sandbox                    #
# --                                                                    #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: Remove legacy Docker container
  ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"
  vars:
    var_prefix: "plex-meta-manager"

- name: "Check if '{{ server_appdata_path }}/plex-meta-manager' exists"
  ansible.builtin.stat:
    path: "{{ server_appdata_path }}/plex-meta-manager"
  register: opt_pmm

- name: "Check if overridden path exists"
  ansible.builtin.stat:
    path: "{{ server_appdata_path }}/{{ plex_meta_manager_name }}"
  register: opt_pmm_name
  when: (plex_meta_manager_name is defined and plex_meta_manager_name | length > 0)

- name: "Check if '{{ server_appdata_path }}/kometa' exists"
  ansible.builtin.stat:
    path: "{{ server_appdata_path }}/kometa"
  register: opt_kometa

- name: Migrate PMM appdata
  when: (opt_pmm.stat.exists or (opt_pmm_name is defined and opt_pmm_name.stat is defined and opt_pmm_name.stat.exists))
  block:
    - name: Relocate '{{ server_appdata_path }}/kometa' to '{{ server_appdata_path }}/kometa_bak'
      ansible.builtin.shell: "mv {{ server_appdata_path }}/kometa {{ server_appdata_path }}/kometa_bak"
      register: kometa_relocate
      when: opt_kometa.stat.exists

    - name: Relocate '{{ server_appdata_path }}/plex-meta-manager' to '{{ server_appdata_path }}/kometa'
      ansible.builtin.shell: "mv {{ server_appdata_path }}/plex-meta-manager {{ server_appdata_path }}/kometa"
      register: pmm_relocate
      when: opt_pmm.stat.exists

    - name: Relocate '{{ server_appdata_path }}/{{ plex_meta_manager_name }}' to '{{ server_appdata_path }}/kometa'
      ansible.builtin.shell: "mv {{ server_appdata_path }}/{{ plex_meta_manager_name }} {{ server_appdata_path }}/kometa"
      register: pmm_name_relocate
      when: opt_pmm_name is defined and opt_pmm_name.stat is defined and opt_pmm_name.stat.exists

    - name: Print Kometa tag instructions
      ansible.builtin.debug:
        msg: "Your appdata has been migrated to '{{ server_appdata_path }}/kometa'. You may now run 'sb install sandbox-kometa' to deploy Kometa."
