##########################################################################
# Title:            Sandbox: Wireguard | Default Variables               #
# Author(s):        owine, salty                                         #
# URL:              https://github.com/saltyorg/Sandbox                  #
# --                                                                     #
##########################################################################
#                   GNU General Public License v3.0                      #
##########################################################################
---
################################
# Basics
################################

wireguard_name: wireguard

################################
# Settings
################################

wireguard_role_listen_port: "51820"
wireguard_role_dns: "1.1.1.1,8.8.8.8"

################################
# Lookups
################################

# Do not edit or override using the inventory
wireguard_role_docker_ipam_config:
  - subnet: "10.42.42.0/24"
  - subnet: "{{ 'fdcc:ad94:bacf:61a3::/64' if docker_ipv6 else omit }}"

################################
# Paths
################################

wireguard_role_paths_folder: "{{ wireguard_name }}"
wireguard_role_paths_location: "{{ server_appdata_path }}/{{ wireguard_role_paths_folder }}"
wireguard_role_paths_folders_list:
  - "{{ wireguard_role_paths_location }}"

################################
# Web
################################

wireguard_role_web_subdomain: "{{ wireguard_name }}"
wireguard_role_web_domain: "{{ user.domain }}"
wireguard_role_web_port: "51821"
wireguard_role_web_url: "{{ 'https://' + (lookup('role_var', '_web_subdomain', role='wireguard') + '.' + lookup('role_var', '_web_domain', role='wireguard')
                         if (lookup('role_var', '_web_subdomain', role='wireguard') | length > 0)
                         else lookup('role_var', '_web_domain', role='wireguard')) }}"
wireguard_role_web_host: "{{ (lookup('role_var', '_web_subdomain', role='wireguard') + '.' + lookup('role_var', '_web_domain', role='wireguard')
                          if (lookup('role_var', '_web_subdomain', role='wireguard') | length > 0)
                          else lookup('role_var', '_web_domain', role='wireguard')) }}"

################################
# DNS
################################

wireguard_role_dns_record: "{{ lookup('role_var', '_web_subdomain', role='wireguard') }}"
wireguard_role_dns_zone: "{{ lookup('role_var', '_web_domain', role='wireguard') }}"
wireguard_role_dns_proxy: "{{ dns_proxied }}"

################################
# Traefik
################################

wireguard_role_traefik_sso_middleware: "{{ traefik_default_sso_middleware }}"
wireguard_role_traefik_middleware_default: "{{ traefik_default_middleware }}"
wireguard_role_traefik_middleware_custom: ""
wireguard_role_traefik_certresolver: "{{ traefik_default_certresolver }}"
wireguard_role_traefik_enabled: true
wireguard_role_traefik_api_enabled: false
wireguard_role_traefik_api_endpoint: ""

################################
# Docker
################################

# Container
wireguard_role_docker_container: "{{ wireguard_name }}"

# Image
wireguard_role_docker_image_pull: true
wireguard_role_docker_image_repo: "ghcr.io/wg-easy/wg-easy"
wireguard_role_docker_image_tag: "15"
wireguard_role_docker_image: "{{ lookup('role_var', '_docker_image_repo', role='wireguard') }}:{{ lookup('role_var', '_docker_image_tag', role='wireguard') }}"

# Ports
wireguard_role_docker_ports_default:
  - "{{ lookup('role_var', '_listen_port', role='wireguard') }}:{{ lookup('role_var', '_listen_port', role='wireguard') }}/udp"
wireguard_role_docker_ports_custom: []
wireguard_role_docker_ports: "{{ lookup('role_var', '_docker_ports_default', role='wireguard')
                                 + lookup('role_var', '_docker_ports_custom', role='wireguard') }}"

# Envs
wireguard_role_docker_envs_default:
  TZ: "{{ tz }}"
  DISABLE_IPV6: "{{ 'false' if docker_ipv6 else 'true' }}"
  WG_DEVICE: "eth0"
wireguard_role_docker_envs_setup:
  INIT_ENABLED: "true"
  INIT_USERNAME: "{{ user.name }}"
  INIT_PASSWORD: "{{ user.pass }}"
  INIT_HOST: "{{ lookup('role_var', '_web_host', role='wireguard') }}"
  INIT_PORT: "{{ lookup('role_var', '_listen_port', role='wireguard') }}"
  INIT_DNS: "{{ lookup('role_var', '_dns', role='wireguard') }}"
  INIT_IPV4_CIDR: "10.8.0.0/24"
  INIT_IPV6_CIDR: "2001:0DB8::/32"
wireguard_role_docker_envs_custom: {}
wireguard_role_docker_envs: "{{ lookup('role_var', '_docker_envs_default', role='wireguard')
                                | combine(lookup('role_var', '_docker_envs_setup', role='wireguard')
                                          if not (wireguard_db.stat.exists | default(false))
                                          else {})
                                | combine(lookup('role_var', '_docker_envs_custom', role='wireguard')) }}"

# Volumes
wireguard_role_docker_volumes_default:
  - "{{ lookup('role_var', '_paths_location', role='wireguard') }}:/etc/wireguard"
  - /lib/modules:/lib/modules:ro
wireguard_role_docker_volumes_custom: []
wireguard_role_docker_volumes: "{{ lookup('role_var', '_docker_volumes_default', role='wireguard')
                                   + lookup('role_var', '_docker_volumes_custom', role='wireguard') }}"

# Hostname
wireguard_role_docker_hostname: "{{ wireguard_name }}"

# Networks
wireguard_role_docker_networks_alias: "{{ wireguard_name }}"
wireguard_role_docker_networks_default:
  - name: wg
    ipv4_address: "10.42.42.42"
    ipv6_address: "{{ 'fdcc:ad94:bacf:61a3::2a' if docker_ipv6 else omit }}"
    gw_priority: 1
    driver_opts:
      com.docker.network.endpoint.ifname: eth0
wireguard_role_docker_networks_custom: []
wireguard_role_docker_networks: "{{ (docker_networks_common | map('combine', {'driver_opts': {'com.docker.network.endpoint.ifname': 'eth1'}}) | list)
                                    + lookup('role_var', '_docker_networks_default', role='wireguard')
                                    + lookup('role_var', '_docker_networks_custom', role='wireguard') }}"

# Capabilities
wireguard_role_docker_capabilities_default:
  - NET_ADMIN
  - SYS_MODULE
wireguard_role_docker_capabilities_custom: []
wireguard_role_docker_capabilities: "{{ lookup('role_var', '_docker_capabilities_default', role='wireguard')
                                        + lookup('role_var', '_docker_capabilities_custom', role='wireguard') }}"

# Sysctls
wireguard_role_docker_sysctls_ipv4:
  net.ipv4.conf.all.src_valid_mark: "1"
  net.ipv4.ip_forward: "1"
wireguard_role_docker_sysctls_ipv6:
  net.ipv6.conf.all.disable_ipv6: "0"
  net.ipv6.conf.all.forwarding: "1"
  net.ipv6.conf.default.forwarding: "1"
wireguard_role_docker_sysctls: "{{ lookup('role_var', '_docker_sysctls_ipv4', role='wireguard')
                                   + (lookup('role_var', '_docker_sysctls_ipv6', role='wireguard')
                                     if docker_ipv6
                                     else []) }}"

# Restart Policy
wireguard_role_docker_restart_policy: unless-stopped

# State
wireguard_role_docker_state: started
